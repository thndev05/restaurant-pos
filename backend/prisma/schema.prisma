// ===== CONFIG =====
generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ===== ENUMS =====
enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  OUT_OF_SERVICE
}

enum RoleName {
  ADMIN
  MANAGER
  CASHIER
  WAITER
  KITCHEN
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum SessionStatus {
  ACTIVE
  PAID
  CLOSED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  SERVED
  PAID
  CANCELLED
}

enum OrderItemStatus {
  PENDING
  COOKING
  READY
  SERVED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CASH
  BANKING
  CARD
}

enum OrderType {
  DINE_IN
  TAKE_AWAY
}

enum ActionType {
  CALL_STAFF
  REQUEST_BILL
  REQUEST_WATER
  REQUEST_UTENSILS
  OTHER
}

enum ActionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum NotificationType {
  RESERVATION_NEW
  RESERVATION_CONFIRMED
  RESERVATION_CANCELLED
  ORDER_NEW
  ORDER_CONFIRMED
  ORDER_READY
  ORDER_ITEM_READY
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  CUSTOMER_REQUEST
  SYSTEM_ALERT
  TABLE_SESSION_STARTED
}

// ===== MODELS =====
model MenuItem {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  description String?
  price       Decimal   @db.Decimal(10, 2)
  image       String?
  isAvailable Boolean   @default(true) @map("is_available")
  isActive    Boolean   @default(true) @map("is_active")
  tags        String[]  @default([])
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  categoryId  String?   @map("category_id") @db.Uuid
  category    Category? @relation("CategoryToMenuItems", fields: [categoryId], references: [id])

  orderItems OrderItem[]

  @@map("menu_items")
}

model Category {
  id           String     @id @default(uuid()) @db.Uuid
  name         String     @unique
  description  String?
  displayOrder Int        @default(0) @map("display_order")
  isActive     Boolean    @default(true) @map("is_active")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  menuItems MenuItem[] @relation("CategoryToMenuItems")

  @@map("categories")
}

model Table {
  id           String         @id @default(uuid()) @db.Uuid
  number       Int            @unique
  capacity     Int            @default(2)
  status       TableStatus    @default(AVAILABLE)
  qrCodeKey    String         @unique @default(uuid()) @map("qr_code_key") @db.Uuid
  location     String?
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  reservations Reservation[]
  sessions     TableSession[]

  @@map("tables")
}

model Customer {
  id           String        @id @default(uuid()) @db.Uuid
  name         String
  phone        String        @unique
  email        String?       @unique
  isActive     Boolean       @default(true) @map("is_active")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  reservations Reservation[]

  @@map("customers")
}

model Permission {
  id          String           @id @default(uuid()) @db.Uuid
  name        String           @unique
  description String?
  resource    String
  action      String
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  roles RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model Role {
  id          String         @id @default(uuid()) @db.Uuid
  name        RoleName       @unique
  displayName String         @map("display_name")
  description String?
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  users       User[]           @relation("UserToRole")
  permissions RolePermission[]

  @@map("roles")
}

model RolePermission {
  id           String     @id @default(uuid()) @db.Uuid
  roleId       String     @map("role_id") @db.Uuid
  permissionId String     @map("permission_id") @db.Uuid
  createdAt    DateTime   @default(now()) @map("created_at")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  username  String   @unique
  password  String   @map("password_hash")
  isActive  Boolean  @default(true) @map("is_active")
  roleId    String   @map("role_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  role            Role          @relation("UserToRole", fields: [roleId], references: [id])
  confirmedOrders Order[]       @relation("OrderConfirmedBy")
  handledActions  StaffAction[] @relation("ActionHandledBy")
  notifications   Notification[]

  @@map("users")
}

// ===== RESERVATION SYSTEM =====
model Reservation {
  id              String            @id @default(uuid()) @db.Uuid
  reservationTime DateTime          @map("reservation_time")
  partySize       Int               @map("party_size")
  status          ReservationStatus @default(PENDING)
  notes           String?           @db.Text
  guestName       String?           @map("guest_name")
  guestPhone      String?           @map("guest_phone")
  customerId      String?           @map("customer_id") @db.Uuid
  tableId         String            @map("table_id") @db.Uuid
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  customer Customer? @relation(fields: [customerId], references: [id])
  table    Table     @relation(fields: [tableId], references: [id])

  @@index([tableId, reservationTime])
  @@index([customerId])
  @@map("reservations")
}

// ===== QR ORDERING SYSTEM =====
model TableSession {
  id            String        @id @default(uuid()) @db.Uuid
  sessionSecret String        @unique @default(uuid()) @map("session_secret") @db.Uuid
  startTime     DateTime      @default(now()) @map("start_time")
  endTime       DateTime?     @map("end_time")
  expiresAt     DateTime      @map("expires_at")
  status        SessionStatus @default(ACTIVE)
  customerCount Int?          @map("customer_count")
  notes         String?       @db.Text
  tableId       String        @map("table_id") @db.Uuid
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  table        Table         @relation(fields: [tableId], references: [id])
  orders       Order[]
  payment      Payment?
  staffActions StaffAction[]

  @@index([tableId, status])
  @@index([startTime])
  @@index([sessionSecret])
  @@map("table_sessions")
}

model Order {
  id            String       @id @default(uuid()) @db.Uuid
  status        OrderStatus  @default(PENDING)
  orderType     OrderType    @default(DINE_IN) @map("order_type")
  customerName  String?      @map("customer_name")
  customerPhone String?      @map("customer_phone")
  notes         String?      @db.Text
  sessionId     String?      @map("session_id") @db.Uuid
  confirmedById String?      @map("confirmed_by_id") @db.Uuid
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  session     TableSession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  confirmedBy User?         @relation("OrderConfirmedBy", fields: [confirmedById], references: [id])
  orderItems  OrderItem[]
  payment     Payment?

  @@index([sessionId, status])
  @@index([orderType, status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id              String          @id @default(uuid()) @db.Uuid
  quantity        Int
  priceAtOrder    Decimal         @db.Decimal(10, 2) @map("price_at_order")
  itemNameAtOrder String          @map("item_name_at_order")
  status          OrderItemStatus @default(PENDING)
  notes           String?         @db.Text
  allergies       String[]        @default([])
  cookingStartedAt DateTime?      @map("cooking_started_at")
  readyAt         DateTime?       @map("ready_at")
  servedAt        DateTime?       @map("served_at")
  rejectionReason String?         @map("rejection_reason")
  orderId         String          @map("order_id") @db.Uuid
  menuItemId      String          @map("menu_item_id") @db.Uuid
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem MenuItem @relation(fields: [menuItemId], references: [id])

  @@index([orderId, status])
  @@index([menuItemId])
  @@map("order_items")
}

// ===== PAYMENT SYSTEM =====
model Payment {
  id            String        @id @default(uuid()) @db.Uuid
  totalAmount   Decimal       @db.Decimal(10, 2) @map("total_amount")
  subTotal      Decimal       @db.Decimal(10, 2) @map("sub_total")
  tax           Decimal       @default(0) @db.Decimal(10, 2)
  discount      Decimal       @default(0) @db.Decimal(10, 2)
  paymentMethod PaymentMethod @map("payment_method")
  status        PaymentStatus @default(PENDING)
  transactionId String?       @unique @map("transaction_id")
  paymentTime   DateTime?     @map("payment_time")
  notes         String?       @db.Text
  sessionId     String?       @unique @map("session_id") @db.Uuid
  orderId       String?       @unique @map("order_id") @db.Uuid
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  session TableSession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  order   Order?        @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([paymentTime])
  @@map("payments")
}

// ===== STAFF ACTION SYSTEM =====
model StaffAction {
  id          String       @id @default(uuid()) @db.Uuid
  actionType  ActionType   @map("action_type")
  status      ActionStatus @default(PENDING)
  description String?      @db.Text
  sessionId   String       @map("session_id") @db.Uuid
  handledById String?      @map("handled_by_id") @db.Uuid
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  session   TableSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  handledBy User?        @relation("ActionHandledBy", fields: [handledById], references: [id])

  @@index([sessionId, status])
  @@index([actionType, status])
  @@map("staff_actions")
}

// ===== NOTIFICATION SYSTEM =====
model Notification {
  id        String           @id @default(uuid()) @db.Uuid
  type      NotificationType
  title     String
  message   String           @db.Text
  metadata  Json?
  isRead    Boolean          @default(false) @map("is_read")
  userId    String           @map("user_id") @db.Uuid
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}